[1504. Count Submatrices With All Ones](https://leetcode.com/problems/count-submatrices-with-all-ones/)

# Intuition

* A submatrix with all `1`s is essentially formed when we can "stack" continuous `1`s vertically and extend them horizontally.
* Think of each row as the **base of a histogram**, where the "height" of each column increases if the cell has `1`, otherwise resets to `0`.
* Then, for each row, the problem reduces to:
  **"How many sub-rectangles end at this row?"**
* By summing up across all rows, we count every possible submatrix.

---

# Approach

1. **Build heights (histogram idea):**

   * Traverse row by row.
   * For each cell `(i, j)`, maintain a `heights[j]` array.
   * If `mat[i][j] == 1`, then `heights[j] += 1`, else reset `heights[j] = 0`.

2. **Count submatrices for each row using monotonic stack:**

   * For the histogram at each row (`heights`), we want the number of submatrices ending at that row.
   * Use a **monotonic increasing stack** to compute:
     * For each column, how many rectangles can be formed with that column as the right boundary.
   * This works similar to "sum of minimums of subarrays".

3. **Accumulate the result across all rows.**

---

# Complexity

* Let `m = rows`, `n = cols`.
* Building histogram heights: `O(m * n)`.
* Counting submatrices per row with stack: `O(n)` per row.
* **Total Time Complexity:** `O(m * n)`
* **Space Complexity:** `O(n)` for heights and stack.

---

# Code

```typescript
function numSubmat(mat: number[][]): number {
    const m = mat.length;
    const n = mat[0].length;
    const heights = Array(n).fill(0);
    let result = 0;

    for (let i = 0; i < m; i++) {
        // Step 1: Build histogram heights
        for (let j = 0; j < n; j++) {
            heights[j] = mat[i][j] === 0 ? 0 : heights[j] + 1;
        }

        // Step 2: Count submatrices ending at this row using stack
        result += countRectanglesInHistogram(heights);
    }
    return result;
}

// Helper function: Count rectangles from histogram using monotonic stack
function countRectanglesInHistogram(heights: number[]): number {
    const n = heights.length;
    const stack: number[] = [];
    const sum = Array(n).fill(0);
    let res = 0;

    for (let i = 0; i < n; i++) {
        while (stack.length && heights[stack[stack.length - 1]] >= heights[i]) {
            stack.pop();
        }

        if (stack.length > 0) {
            const prevIndex = stack[stack.length - 1];
            sum[i] = sum[prevIndex] + heights[i] * (i - prevIndex);
        } else {
            sum[i] = heights[i] * (i + 1);
        }

        res += sum[i];
        stack.push(i);
    }
    return res;
};

```

---

## Example Walkthrough

### Input:

```ts
mat = [
  [1, 0, 1],
  [1, 1, 0],
  [1, 1, 0]
]
```

### Step-by-step:

* **Row 1:** `[1,0,1] → heights=[1,0,1]`
  * Rectangles = 2 (two `1x1`)
    
* **Row 2:** `[1,1,0] → heights=[2,1,0]`
  * Rectangles = 4 (3 new from histogram + previous 1 counted)
    
* **Row 3:** `[1,1,0] → heights=[3,2,0]`
  * Rectangles = 7 (more submatrices added)

**Total = 13.**

So the output for this example is **13**, as expected.

---
